<!doctype html>
<html lang="es">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Potatorrent</title>

    <link rel="icon" type="image/svg+xml"
        href="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/Twemoji2_1f954.svg/1024px-Twemoji2_1f954.svg.png"
        sizes="any">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Anton&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/css/select2.min.css" rel="stylesheet" />

    <style>
        .select2-container--bootstrap4 .select2-selection--single {
            height: calc(2.25rem + 2px) !important;
        }

        .select2-container--bootstrap4 .select2-selection--single .select2-selection__placeholder {
            color: #757575;
            line-height: 2.25rem;
        }

        .select2-container--bootstrap4 .select2-selection--single .select2-selection__arrow {
            position: absolute;
            top: 50%;
            right: 3px;
            width: 20px;
        }

        .select2-container--bootstrap4 .select2-selection--single .select2-selection__arrow b {
            top: 60%;
            border-color: #343a40 transparent transparent transparent;
            border-style: solid;
            border-width: 5px 4px 0 4px;
            width: 0;
            height: 0;
            left: 50%;
            margin-left: -4px;
            margin-top: -2px;
            position: absolute;
        }

        .select2-container--bootstrap4 .select2-selection--single .select2-selection__rendered {
            line-height: 2.25rem;
        }

        .select2-search--dropdown .select2-search__field {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }

        .select2-results__message {
            color: #6c757d;
        }

        .select2-container--bootstrap4 .select2-selection--multiple {
            min-height: calc(2.25rem + 2px) !important;
        }

        .select2-container--bootstrap4 .select2-selection--multiple .select2-selection__rendered {
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            list-style: none;
            margin: 0;
            padding: 0 5px;
            width: 100%;
        }

        .select2-container--bootstrap4 .select2-selection--multiple .select2-selection__choice {
            color: #343a40;
            border: 1px solid #bdc6d0;
            border-radius: 0.2rem;
            padding: 0;
            padding-right: 5px;
            cursor: pointer;
            float: left;
            margin-top: 0.3em;
            margin-right: 5px;
        }

        .select2-container--bootstrap4 .select2-selection--multiple .select2-selection__choice__remove {
            color: #bdc6d0;
            font-weight: bold;
            margin-left: 3px;
            margin-right: 1px;
            padding-right: 3px;
            padding-left: 3px;
            float: left;
        }

        .select2-container--bootstrap4 .select2-selection--multiple .select2-selection__choice__remove:hover {
            color: #343a40;
        }

        .select2-container {
            display: block;
        }

        .select2-container *:focus {
            outline: 0;
        }

        .input-group .select2-container--bootstrap4 {
            -webkit-box-flex: 1;
            -ms-flex-positive: 1;
            flex-grow: 1;
        }

        .input-group-prepend~.select2-container--bootstrap4 .select2-selection {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .input-group>.select2-container--bootstrap4:not(:last-child) .select2-selection {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .select2-container--bootstrap4 .select2-selection {
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            -webkit-transition: border-color 0.15s ease-in-out, -webkit-box-shadow 0.15s ease-in-out;
            transition: border-color 0.15s ease-in-out, -webkit-box-shadow 0.15s ease-in-out;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out, -webkit-box-shadow 0.15s ease-in-out;
            width: 100%;
        }

        @media screen and (prefers-reduced-motion: reduce) {
            .select2-container--bootstrap4 .select2-selection {
                -webkit-transition: none;
                transition: none;
            }
        }

        .select2-container--bootstrap4.select2-container--focus .select2-selection {
            border-color: #80bdff;
            -webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .select2-container--bootstrap4.select2-container--focus.select2-container--open .select2-selection {
            border-bottom: none;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .select2-container--bootstrap4.select2-container--disabled .select2-selection,
        .select2-container--bootstrap4.select2-container--disabled.select2-container--focus .select2-selection {
            background-color: #e9ecef;
            cursor: not-allowed;
            border-color: #ced4da;
            -webkit-box-shadow: none;
            box-shadow: none;
        }

        .select2-container--bootstrap4.select2-container--disabled .select2-search__field,
        .select2-container--bootstrap4.select2-container--disabled.select2-container--focus .select2-search__field {
            background-color: transparent;
        }

        select.is-invalid~.select2-container--bootstrap4 .select2-selection,
        form.was-validated select:invalid~.select2-container--bootstrap4 .select2-selection {
            border-color: #dc3545;
        }

        select.is-valid~.select2-container--bootstrap4 .select2-selection,
        form.was-validated select:valid~.select2-container--bootstrap4 .select2-selection {
            border-color: #28a745;
        }

        .select2-container--bootstrap4 .select2-dropdown {
            border-color: #ced4da;
            border-top: none;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }

        .select2-container--bootstrap4 .select2-dropdown.select2-dropdown--above {
            border-top: 1px solid #ced4da;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }

        .select2-container--bootstrap4 .select2-dropdown .select2-results__option[aria-selected=true] {
            background-color: #e9ecef;
        }

        .select2-container--bootstrap4 .select2-results__option--highlighted,
        .select2-container--bootstrap4 .select2-results__option--highlighted.select2-results__option[aria-selected=true] {
            background-color: #007bff;
            color: #f8f9fa;
        }

        .select2-container--bootstrap4 .select2-results__option[role=group] {
            padding: 0;
        }

        .select2-container--bootstrap4 .select2-results>.select2-results__options {
            max-height: 15em;
            overflow-y: auto;
        }

        .select2-container--bootstrap4 .select2-results__group {
            padding: 6px;
            display: list-item;
            color: #6c757d;
        }

        .select2-container--bootstrap4 .select2-selection__clear {
            width: 1.2em;
            height: 1.2em;
            line-height: 1.15em;
            padding-left: 0.3em;
            margin-top: 0.5em;
            border-radius: 100%;
            background-color: #6c757d;
            color: #f8f9fa;
            float: right;
            margin-right: 0.3em;
        }

        .select2-container--bootstrap4 .select2-selection__clear:hover {
            background-color: #343a40;
        }
    </style>
    <style>
        body {
            font-family: 'Lato', sans-serif;
        }

        .btn {
            border-radius: 0;
        }

        .btn-primary {
            background-color: #d99e82;
            border: none;
        }

        .fa-spinner {
            color: #c8775e;
        }

        .btn-primary:hover,
        .btn-primary:active {
            background-color: #c8775e !important;
        }

        .btn-primary:focus {
            box-shadow: none;
        }

        .page-link {
            color: #c8775e;
        }

        .page-link:hover {
            color: #c8775e;
        }

        .page-item.active .page-link {
            background-color: #d99e82;
            border: none;
            color: #fff;
        }

        .badge {
            border-radius: 0;
        }

        #title {
            font-family: 'Anton', sans-serif;
            font-size: 1.5rem;
            text-decoration: none;
            color: inherit;
        }

        #title:hover {
            text-decoration: none;
            color: inherit;
        }

        #update {
            padding: 0.5rem;
            color: #fff;
            position: absolute;
            right: 10px;
        }

        #update .fa-spinner {
            color: #fff;
        }

        #top-bar {
            box-shadow: 0px 2px 5px #000;
        }

        .torrent-title {
            text-shadow: 0px 2px 2px #ccc;
        }

        .torrent-fecha {
            font-size: .8rem;
        }
    </style>
</head>

<body>

    <div id="top-bar" class="bg-dark text-light sticky-top text-center py-1 px-3">
        <a id="title" href="#">
            potatorrent
            <img height="36px"
                src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/Twemoji2_1f954.svg/1024px-Twemoji2_1f954.svg.png" />
        </a>
        <a id="update" target="_blank" href="https://github.com/nilbelec/potatorrent/releases"
            class="badge badge-dark my-1" data-toggle="tooltip" data-placement="left" title="Tienes la última versión">
            <i class="fa fa-spinner fa-pulse"></i>
        </a>
    </div>
    <main class="py-4">
        <div class="container">
            <div class="form-row">
                <div class="form-group col">
                    <select id="categoria" class="form-control" disabled>
                        <option value=""></option>
                    </select>
                </div>
                <div class="form-group col">
                    <select id="subcategoria" class="form-control" disabled>
                        <option value=""></option>
                    </select>
                </div>
                <div class="form-group col">
                    <select id="calidad" class="form-control" disabled>
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col">
                    <input id="search-input" class="form-control mr-sm-2" type="search" placeholder="Por palabras..."
                        aria-label="Search" disabled>
                </div>
            </div>
            <button type="button" id="search" class="btn btn-primary btn-block">Buscar</button>
        </div>
        </div>
        <div class="container pt-3 pb-5" id="search-container">
            <small id="search-results-info" class="text-muted"></small>
            <div id="search-results-container"></div>
            <nav id="search-results-pagination" class="my-1 fixed-bottom"></nav>
        </div>
    </main>

    <div id="result-template-container" hidden>
        <div class="torrent row py-3 border-bottom">
            <div class="col-auto my-auto">
                <img class="torrent-img rounded" style="width: 90px;" />
            </div>
            <div class="col">
                <div class="row h-100">
                    <div class="col">
                        <span class="torrent-title"></span>
                    </div>
                    <div class="col-auto">
                        <span title="Fecha de publicación" class="torrent-fecha badge badge-dark"></span>
                    </div>
                    <div class="w-100"></div>
                    <div class="col mt-auto">
                        <span title="Calidad o tipo de elemento" class="torrent-calidad badge badge-info"></span>
                    </div>
                    <div class="col mt-auto text-right text-md-center">
                        <span title="Tamaño de la descarga" class="torrent-tamano badge badge-warning"></span>
                    </div>
                    <div class="col-12 col-md mt-3 mt-md-auto">
                        <button type="button" class="torrent-download btn btn-danger btn-sm float-right">
                            Descargar Torrent
                            <i class="fa fa-download" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="password-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Contraseña para descomprimir:</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <span id="password" class="bg-danger d-block p-3 text-center text-light"></span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="not-found-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
                        Parece que el fichero torrent ya no existe... :(
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/js/select2.min.js"></script>

    <script>
        $.postJSON = function (url, data) {
            return $.ajax({
                url: url,
                data: JSON.stringify(data),
                contentType: 'application/json',
                method: 'POST'
            });
        }
    </script>

    <script>

        $(function () {
            $.getJSON("/version")
                .done(function (response) {
                    if (!response)
                        return;
                    $('#update').html(response.current);
                    if (response.current !== response.latest) {
                        $('#update').prop('title', 'Hay una nueva versión disponible: ' + response.latest)
                        $('#update').toggleClass('badge-dark badge-success')
                    }
                    $('#update').tooltip()
                });

            $.getJSON("/options")
                .done(function (response) {
                    if (!response)
                        return;
                    appendOptions('#categoria', response.categorias);
                    appendOptions('#calidad', response.calidades);
                    $('#search-input').prop('disabled', false);
                    $('#categoria').prop('disabled', false).select2({
                        placeholder: 'Elige una categoría',
                        width: '100%',
                        allowClear: true,
                        theme: 'bootstrap4'
                    });
                    $('#calidad').prop('disabled', false).select2({
                        placeholder: 'Elige la calidad del contenido',
                        width: '100%',
                        allowClear: true,
                        theme: 'bootstrap4'
                    });
                });

            $('#title').on('click', function () {
                $("html, body").animate({ scrollTop: 0 }, 500);
            })

            $('#subcategoria').select2({
                placeholder: 'Elige una subcategoría',
                allowClear: true,
                width: '100%',
                theme: 'bootstrap4'
            });

            function appendOptions(selector, map) {
                if (!selector || !map)
                    return;
                var sortable = [];
                for (var key in map) {
                    sortable.push([key, map[key]]);
                }

                sortable.sort(function (a, b) {
                    return a[1].localeCompare(b[1]);
                });
                for (var k in sortable) {
                    $(selector).append('<option value="' + sortable[k][0] + '">' + sortable[k][1] + '</option>')
                }
            }

            $('#search-input').on('keyup', function (e) {
                if (e.which == 13)
                    $('#search').trigger('click');
            });

            $('#categoria').on('change', function () {
                $('#subcategoria').prop('disabled', true)
                $('#subcategoria').html('<option selected value=""></option>');
                const categoria = $('#categoria').val();
                if (!categoria) {
                    return;
                }
                $('#subcategoria').prop('disabled', false)
                $.getJSON("/subcategories", { categoria: categoria })
                    .done(function (response) {
                        if (!response)
                            return;
                        appendOptions('#subcategoria', response);
                    })
            })

            const parent = document.getElementById('result-template-container');
            const template = parent.innerHTML;
            parent.remove()

            const loading = '<div class="text-center"><i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i></div>';

            $('#search').on('click', function () {
                $('#search-container').data('params', {
                    categoria: $('#categoria').val(),
                    subcategoria: $('#subcategoria').val(),
                    calidad: $('#calidad').val(),
                    q: $('#search-input').val(),
                    pg: 1,
                });
                $('#search-results-info').empty();
                $('#search-results-pagination').css('bottom', '-80px').empty();
                doSearch();
            });

            function doSearch() {
                $('#search-results-container').html(loading);
                var params = $('#search-container').data('params');
                $.getJSON("/search", params).done(function (response) {
                    $('#search-results-container').empty()
                    if (!response || !response.success) {
                        $('#search-results-container').html('<div class="alert alert-danger">Se ha producido un error...</div>')
                        return;
                    }
                    if (!response.data.items) {
                        $('#search-results-container').html('<div class="alert alert-info">No se han encontrado resultados</div>')
                        return;
                    }
                    const page = params.pg;
                    const first = ((page - 1) * 30) + 1
                    const last = first + response.data.items - 1;
                    const total = response.data.total;
                    $('#search-results-info').html('Mostrando resultados del <strong>' + first + ' al ' + last + '</strong> de un total de <strong>' + total + '</strong>');
                    if (response.data.all > 1) {
                        const ul = $('<ul class="pagination justify-content-center"></ul>');
                        if (response.data.all > 9)
                            ul.append('<li class="page-item' + (page == 1 ? ' disabled' : '') + '"><a class="page-link" data-page="' + 1 + '" href="#"><i class="fa fa-angle-double-left" aria-hidden="true"></i></a></li>')
                        ul.append('<li class="page-item' + (page == 1 ? ' disabled' : '') + '"><a class="page-link" data-page="' + (page - 1) + '" href="#"><i class="fa fa-angle-left" aria-hidden="true"></i></a></li>')
                        for (var k = 0; k < 5; k++) {
                            var c = page - 2;
                            while (c < 1)
                                c++;
                            c += k;
                            if (c <= response.data.all)
                                ul.append('<li class="page-item' + (c == page ? ' active' : '') + '"><a class="page-link" data-page="' + c + '" href="#">' + c + '</a></li>')
                        }
                        ul.append('<li class="page-item' + (page == response.data.all ? ' disabled' : '') + '"><a class="page-link" data-page="' + (page + 1) + '" href="#"><i class="fa fa-angle-right" aria-hidden="true"></i></a></li>')
                        if (response.data.all > 9)
                            ul.append('<li class="page-item' + (page == response.data.all ? ' disabled' : '') + '"><a class="page-link" data-page="' + response.data.all + '" href="#"><i class="fa fa-angle-double-right" aria-hidden="true"></i></a></li>')
                        $('#search-results-pagination').html(ul).animate({ bottom: "0" }, 500);
                        $('#search-results-pagination').find('.page-link').on('click', function (e) {
                            e.preventDefault();
                            var params = $('#search-container').data('params');
                            params.pg = Number($(this).data('page'));
                            $('#search-container').data('params', params);
                            doSearch();
                        })
                    }
                    for (let k in response.data.torrents["0"]) {
                        const t = response.data.torrents["0"][k];

                        const $cont = $(template);
                        $cont.find('.torrent-img').prop('src', '/image?path=' + (t.imagen == '/pictures/f/thumbs/' ? '/d20/library/content/template/images/no-imagen.jpg' : t.imagen))
                        $cont.find('.torrent-title').text(t.torrentName)
                        $cont.find('.torrent-calidad').text(t.calidad)
                        $cont.find('.torrent-fecha').text(t.torrentDateAdded)
                        $cont.find('.torrent-tamano').text(t.torrentSize)
                        $cont.find('.torrent-download').data('id', t.torrentID).data('guid', t.guid)

                        $('#search-results-container').append($cont)

                        $cont.find('.torrent-download').on('click', function () {
                            const $btn = $(this);
                            $btn.prop('disabled', true);
                            const innerHTML = $btn.html();
                            const id = $btn.data('id');
                            const guid = $btn.data('guid');

                            $btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Buscando...');
                            $.getJSON('/download', { id: id, guid: guid })
                                .done(function (response) {
                                    if (!response || !response.url) {
                                        $('#not-found-modal').modal('show');
                                        return;
                                    }
                                    window.open(response.url);
                                    if (response.password) {
                                        $('#password-modal #password').text(response.password);
                                        $('#password-modal').modal('show');
                                    }
                                }).always(function () {
                                    $btn.prop('disabled', false);
                                    $btn.html(innerHTML);
                                })
                        })
                    }
                })
            }
        });

    </script>
</body>

</html>